<h2>Patient <%= @tasks.study_identifier %></h2>

<div><%= link_to "Clinical Summary", active_report_path(@tasks.id) %></div>
<div><%= link_to AdditionalContact.model_name.human, new_participant_additional_contact_path(@tasks.id) %></div>

<%= @tasks.active_tasks.count %> <%= "task".pluralize(@tasks.active_tasks.count) %>, <%= @tasks.overdue_tasks.count %> overdue

<div class="progress">
  <% @tasks.scheduled_tasks.each_with_index do |task, i| %>
    <%= content_tag("div",
                    class: "progress-bar progress-bar-#{ task.css_class }",
                    style: "width: #{ 100 / @tasks.scheduled_tasks.count }%; border-right: 1px solid;") do %>
      <span><%= task %></span>
    <% end %>
  <% end %>
</div>

<ul class="list-group">
  <% @tasks.active_tasks.each do |task| %>
    <li class="list-group-item">
      <h4><%= task %> <small><%= time_ago_in_words task.scheduled_at %> ago</small></h4>

      <div class="btn-group" role="group" aria-label="Actions">
        <% if task.alert? %>
          <%= link_to "Mark as resolved",
                      new_polymorphic_path([:participant, task.target], { participant_id: @tasks.id }),
                      { class: "btn btn-default" } %>
          <%= button_to "Contact Supervisor",
                        notify_supervisor_participant_task_path(participant_id: @tasks.id, id: task.id),
                        { class: "btn btn-default", data: { confirm: "are you sure you want to notify the supervisor that you need help?" } } %>
          <% if @tasks.latest_notification(task) %>
            <p>last supervisor contact sent <%= l @tasks.latest_notification(task).created_at, format: :long %></p>
            <%= button_to "clear",
                          clear_latest_supervisor_notification_participant_task_path(participant_id: @tasks.id, id: task.id),
                          { method: :delete, class: "btn btn-default", data: { confirm: "are you sure you want to clear this?" } } %>
          <% end %>
        <% else %>
          <%= link_to "Confirm",
              new_polymorphic_path([:participant, task.target], { participant_id: @tasks.id }),
              { class: "btn btn-link" } %>
          <%= button_to "Cancel",
                        cancel_participant_task_path(participant_id: @tasks.id, id: task.id),
                        { method: :put, class: "btn btn-default" } %>
          <%= link_to "Reschedule",
              edit_participant_task_path(participant_id: @tasks.id, id: task.id),
              { class: "btn btn-link" } %>
        <% end %>
      </div>
    </li>
  <% end %>
</ul>
